nextflow_process {

    name "Test Process rnaseq_mapping_star"
    script "modules/rnaseq_mapping_star.nf"
    process "rnaseq_mapping_star"

    test("Should align fastq files to genome using STAR") {

        when {                
            process {
                """
                input[0] = file("${projectDir}/tests/data/genome.fa")
                input[1] = files("${projectDir}/tests/data/genomeDir")
		        input[2] = Channel.fromFilePairs("${projectDir}/tests/data/ENCSR000COQ1_{1,2}.fastq.gz")
                """
            }
        }

        then {
            assert process.success

            // Get the directory containing test results
            def testResultsDir = file('.nf-test/tests')

            //Flag variable to track if bam output file is found
            def outputFileFound = false

            //Iterate through each test directory
            testResultsDir.eachDir { testDir ->
                def outputFile = new File(testDir, "results/ENCSR000COQ1/Aligned.sortedByCoord.out.bam")          
            
                if (outputFile.exists()) {
                   outputFileFound = true
                }
            }

            //Print success message if output file is found in any working  test directory
            if (outputFileFound) {
                print "BAM file was created successfully"
            } else {
                print "BAM file was not created"
            }
        }

    }

}
